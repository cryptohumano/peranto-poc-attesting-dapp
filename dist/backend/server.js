import e,{Router as t}from"express";import i from"body-parser";import{Utils as n,Did as a,connect as o,ConfigService as s,Attestation as r,Blockchain as c,Message as d,Quote as l,CType as u,Credential as m,Claim as p}from"@kiltprotocol/sdk-js";import{cryptoWaitReady as y,randomAsHex as I}from"@polkadot/util-crypto";import{cwd as f}from"node:process";import h from"node:path";import{config as N}from"dotenv";import{pino as E}from"pino";import g from"pino-pretty";import w from"express-basic-auth";import{StatusCodes as b}from"http-status-codes";import{randomUUID as M}from"node:crypto";import D from"node-cache";import{getApps as A,initializeApp as C}from"firebase/app";import{getFirestore as T,setDoc as R,doc as k}from"firebase/firestore";N();class v extends Error{constructor(e){super(e),E().fatal(e),process.exit(1)}}const{env:O}=process,S=O.URL;if(!S)throw new v("URL is not provided");const L=O.DID,j=O.SECRET_PAYER_MNEMONIC;if(!j)throw new v("SECRET_PAYER_MNEMONIC is not provided");const x=O.SECRET_AUTHENTICATION_MNEMONIC;if(!x)throw new v("SECRET_AUTHENTICATION_MNEMONIC is not provided");const U=O.SECRET_ASSERTION_METHOD_MNEMONIC;if(!U)throw new v("SECRET_ASSERTION_METHOD_MNEMONIC is not provided");const Y=O.SECRET_KEY_AGREEMENT_MNEMONIC;if(!Y)throw new v("SECRET_KEY_AGREEMENT_MNEMONIC is not provided");const F=O.BLOCKCHAIN_ENDPOINT;if(!F)throw new v("No blockchain endpoint provided");const Z=O.ADMIN_USERNAME,G=O.ADMIN_PASSWORD;if(!Z||!G)throw new v("Admin credentials missing");const _={port:parseInt(O.PORT)||3e3,blockchainEndpoint:F,baseUri:S,distFolder:h.join(f(),"dist","frontend"),did:L,payerMnemonic:j,authenticationMnemonic:x,assertionMethodMnemonic:U,keyAgreementMnemonic:Y,adminUsername:Z,adminPassword:G},W=(async()=>{await y();return{payer:n.Crypto.makeKeypairFromUri(_.payerMnemonic),authentication:n.Crypto.makeKeypairFromUri(_.authenticationMnemonic),assertionMethod:n.Crypto.makeKeypairFromUri(_.assertionMethodMnemonic),keyAgreement:n.Crypto.makeEncryptionKeypairFromSeed(n.Crypto.mnemonicToMiniSecret(_.keyAgreementMnemonic))}})();async function q(){await o(_.blockchainEndpoint)}async function K(e,t,i){if(!t)throw new Error(`Your on-chain DID is broken: the resolved key for ${i} is undefined`);if(n.Crypto.u8aToHex(e.publicKey)!==n.Crypto.u8aToHex(t.publicKey))throw new Error(`Your on-chain DID is broken: the configured key for ${i} does not match resolved one`)}const H=(async()=>{await q();const{did:e}=_;if(!e)throw new Error("DID not configured, have you run createDID script?");const t=await a.resolve(e);if(!t||!t.document)throw new Error(`Could not resolve the configured DID ${e}, have you run createDID script?`);const{document:i}=t;await async function(e){const t=await W;await K(t.authentication,e.authentication[0],"authentication"),await K(t.assertionMethod,e.assertionMethod?.[0],"assertionMethod"),await K(t.keyAgreement,e.keyAgreement?.[0],"keyAgreement")}(i);const n=i.authentication?.[0];if(!n)throw new Error("Impossible: authentication key not found");const o=i.assertionMethod?.[0];if(!o)throw new Error("Impossible: assertion method key not found");const s=i.keyAgreement?.[0];if(!s)throw new Error("Impossible: key agreement key not found");return{did:e,didDocument:i,authenticationKey:n,assertionMethodKey:o,keyAgreementKey:s}})(),V=g({levelFirst:!0,colorize:!0,ignore:"time,hostname,pid"}),J=E({level:"trace"},V),{adminUsername:z,adminPassword:Q}=_,X=w({users:{[z]:Q},challenge:!0}),B={session:"/api/session",terms:"/api/terms",requestAttestation:"/api/request-attestation",pay:"/api/pay",credentials:{list:"/api/credentials",item:"/api/credentials/:id",attest:"/api/credentials/:id/attest",revoke:"/api/credentials/:id/revoke"}};class $ extends Error{}const P=new Map;function ee(e){const t=M();P.set(t,{claim:e})}function te(e){const t=P.get(e);if(!t)throw new $("Credential not found");return t}function ie(e){if(!P.delete(e))throw new $("Credential not found")}function ne(e,t){const i=te(e);return P.set(e,{...i,attestation:t}),te(e)}async function ae({data:e,keyRelationship:t}){if("capabilityDelegation"===t)throw new Error("Delegation not supported");const{authentication:i,assertionMethod:n}=await W,{did:a,authenticationKey:o,assertionMethodKey:s}=await H,[r,c]="authentication"===t?[i,o]:[n,s],d=`${a}${c.id}`;return{signature:r.sign(e,{withType:!1}),keyType:r.type,keyUri:d}}async function oe({data:e,peerPublicKey:t}){const{keyAgreement:i}=await W,{did:a,keyAgreementKey:o}=await H,s=`${a}${o.id}`,{box:r,nonce:c}=n.Crypto.encryptAsymmetric(e,t,i.secretKey);return{data:r,nonce:c,keyUri:s}}async function se({data:e,nonce:t,peerPublicKey:i}){const{keyAgreement:a}=await W,o=n.Crypto.decryptAsymmetric({box:e,nonce:t},i,a.secretKey);if(!o)throw new Error("Failed to decrypt with given key");return{data:o}}async function re(e){const t=s.get("api"),i=r.fromCredentialAndDid(e,_.did),{claimHash:n,cTypeHash:o}=i,{payer:d}=await W,l=t.tx.attestation.add(n,o,null),u=await a.authorizeTx(_.did,l,ae,d.address);return await c.signAndSubmitTx(u,d),i}async function ce(e){const t=s.get("api"),{rootHash:i}=e,n=t.tx.attestation.revoke(i,null),{payer:o}=await W,d=await a.authorizeTx(_.did,n,ae,o.address);await c.signAndSubmitTx(d,o);const l=await t.query.attestation.attestations(i);return r.fromChain(l,i)}function de(e,t){J.error(e),e instanceof $?t.status(b.NOT_FOUND).send(e):t.status(b.INTERNAL_SERVER_ERROR).send(e)}const le=t();le.get(B.credentials.list,(async(e,t)=>{J.debug("Getting list of credentials"),t.send(Object.fromEntries(P.entries()))})),le.get(B.credentials.item,(async(e,t)=>{try{const{id:i}=e.params;J.debug("Getting credential"),t.send(te(i))}catch(e){de(e,t)}})),le.delete(B.credentials.item,(async(e,t)=>{try{const{id:i}=e.params;J.debug("Deleting credential"),ie(i),t.sendStatus(b.OK)}catch(e){de(e,t)}})),le.post(B.credentials.attest,(async(e,t)=>{try{const{id:i}=e.params;J.debug("Getting credential");const{claim:n}=te(i);J.debug("Attesting credential");const a=await re(n);J.debug("Credential attested, updating database");const o=ne(i,a);t.send(o)}catch(e){de(e,t)}})),le.post(B.credentials.revoke,(async(e,t)=>{try{const{id:i}=e.params;J.debug("Getting credential");const{claim:n}=te(i);J.debug("Revoking credential");const a=await ce(n);J.debug("Credential revoked, updating database");const o=ne(i,a);t.send(o)}catch(e){de(e,t)}}));const ue=t();ue.use(le),ue.use(e.static(`${_.distFolder}/admin`,{dotfiles:"allow",setHeaders(e){e.set("Access-Control-Allow-Origin","*")}})),ue.get("*",((e,t)=>{t.sendFile(`${_.distFolder}/admin/index.html`)}));const me=new D({stdTTL:18e3,useClones:!1});function pe(e){const t=e.get("x-session-id");if(!t)throw new Error("Required header x-session-id is missing");return function(e){const t=me.get(e);if(!t)throw new Error(`Unknown or expired session ${e}`);return t}(t)}function ye(e){me.set(e.sessionId,e)}function Ie(e,t,i){try{const t=function(e){const t=pe(e),{did:i,didConfirmed:n,encryptionKeyUri:a}=t;if(!i||!n||!a)throw new Error("Unconfirmed DID");return{...t,did:i,encryptionKeyUri:a}}(e);e.session=t,i()}catch(e){t.status(b.FORBIDDEN).send(e)}}const fe=t();fe.post(B.pay,Ie,(async function(e,t){try{J.debug("Mock processing payment");const{session:{credential:i}}=e;if(!i)throw new Error("Session credential not found");ee(i),J.debug("Payment received, sent credential to attester"),t.sendStatus(b.NO_CONTENT)}catch(e){J.error(e),t.status(b.INTERNAL_SERVER_ERROR).send(e)}}));const he={email:{$schema:"http://kilt-protocol.org/draft-01/ctype#",title:"Email",properties:{Email:{type:"string"}},type:"object",$id:"kilt:ctype:0x3291bb126e33b4862d421bfaa1d2f272e6cdfc4f96658988fbcffea8914bd9ac"},twitter:{$schema:"http://kilt-protocol.org/draft-01/ctype#",title:"Twitter",properties:{Twitter:{type:"string"}},type:"object",$id:"kilt:ctype:0x47d04c42bdf7fdd3fc5a194bcaa367b2f4766a6b16ae3df628927656d818f420"},id:{$schema:"http://kilt-protocol.org/draft-01/ctype#",properties:{age:{type:"integer"},name:{type:"string"}},title:"INE ID",type:"object",$id:"kilt:ctype:0x3112e1e3fb387e5eb6c109aa45afc7ed9df01f1c90a976a8b00585abf817ca82"}},Ne={id:2,email:2,twitter:3};const Ee=t();function ge(){const e=I(24),t=I(24);return ye({sessionId:e,didChallenge:t}),{challenge:t,sessionId:e}}Ee.post(B.requestAttestation,Ie,(async function(e,t){try{J.debug("Handling attestation request");const i=(await d.decrypt(e.body,se)).body;J.debug("Request attestation message decrypted"),d.verifyMessageBody(i);const{type:n}=i;if("reject"===n||"reject-terms"===n)return void t.status(b.CONFLICT).send("Message contains rejection");if("request-attestation"!==n)throw new Error("Unexpected message type");const{quote:a,credential:o}=i.content;a&&(await l.verifyQuoteAgreement(a),J.debug("Quote agreement verified"));const s=Object.values(he),r=u.hashToId(o.claim.cTypeHash),c=s.find((({$id:e})=>e===r));c||t.status(b.FORBIDDEN).send("Unsupported CType"),J.debug("CType supported"),await m.verifyWellFormed(o,{ctype:c}),J.debug("Credential data structure verified");const{session:p}=e;ye({...p,credential:o}),J.debug("Request attestation complete"),t.sendStatus(b.NO_CONTENT)}catch(e){t.status(b.INTERNAL_SERVER_ERROR).send(e)}}));const we=B.session,be=t();async function Me(e,t){const{did:i}=a.parse(e),n=d.fromBody(t,_.did,i);return d.encrypt(n,oe,e)}be.get(we,(async(e,t)=>{const{did:i,keyAgreementKey:n}=await H,a=`${i}${n.id}`;t.send({dAppEncryptionKeyUri:a,...ge()})})),be.post(we,(function(e,t,i){try{const t=pe(e);e.session=t,i()}catch(e){t.status(b.FORBIDDEN).send(e)}}),(async function(e,t){try{J.debug("Session confirmation started");const i=e.body,{encryptionKeyUri:o,encryptedChallenge:s,nonce:r}=i,{session:c}=e,d=await a.resolveKey(o);J.debug("Session confirmation resolved DID encryption key");const{keyAgreementKey:l,did:u}=await H,{data:m}=await se({data:n.Crypto.coToUInt8(s),nonce:n.Crypto.coToUInt8(r),keyUri:`${u}${l.id}`,peerPublicKey:d.publicKey});J.debug("Session confirmation decrypted challenge");const p=n.Crypto.u8aToHex(m);if(p!==c.didChallenge)return void t.status(b.FORBIDDEN).send("Challenge signature mismatch");ye({...c,did:d.controller,encryptionKeyUri:o,didConfirmed:!0}),J.debug("Challenge confirmation matches"),t.sendStatus(b.NO_CONTENT)}catch(e){t.status(b.INTERNAL_SERVER_ERROR).send(e)}}));const De=t();De.post(B.terms,Ie,(async function(e,t){try{J.debug("Submit terms started");const{session:i}=e,{encryptionKeyUri:n}=i,{type:a,claimContents:o}=e.body,s=p.fromCTypeAndClaimContents(he[a],o,i.did);J.debug("Generated claim");const r={attesterDid:_.did,cTypeHash:s.cTypeHash,cost:{tax:{VAT:0},net:Ne[a],gross:Ne[a]},currency:"KILT",timeframe:new Date(Date.now()+18e6).toISOString(),termsAndConditions:"https://example.com/terms-and-conditions"},c=await l.createAttesterSignedQuote(r,ae);J.debug("Signed quote");const d=await Me(n,{content:{claim:s,legitimations:[],quote:c,cTypes:[he[a]]},type:"submit-terms"});J.debug("Submit terms complete"),t.send(d)}catch(e){t.status(b.INTERNAL_SERVER_ERROR).send(e)}}));const Ae=A(),Ce=T(Ae.length>0?Ae[0]:C({apiKey:"AIzaSyAAwR5GvEUi3lLWy9bb1tz65jhvHI3vufc",authDomain:"peranto-test.firebaseapp.com",projectId:"peranto-test",storageBucket:"peranto-test.appspot.com",messagingSenderId:"777447831295",appId:"1:777447831295:web:6a987d7c8b307ecef43eca"}));const Te=t();Te.post("/api/metamap",(async function(e,t){try{const{eventName:i}=e.body,n=await R(k(Ce,"metamap","testId_"+i),{payload:JSON.stringify({computed:{age:{data:30}},documents:[{country:"MX",merchantFields:[],region:null,type:"national-id",subtype:"credencial-para-votar",steps:[{status:200,id:"age-check",cacheHit:null,data:{age:30,ageThreshold:18,underage:!1},error:null},{status:200,id:"alteration-detection",cacheHit:null,error:null},{status:200,id:"facematch",cacheHit:null,data:{score:100},error:null},{status:200,id:"template-matching",cacheHit:null,error:null},{status:200,id:"document-reading",cacheHit:null,data:{fullName:{value:"EDGAR DANIEL SALINAS LEDESMA",required:!0,label:"Name"},address:{value:"AV MARINA NACIONAL 200 EDIF 1 A 74 U HAB MARINA NACIONAL 11320 MIGUEL HIDALGO, CDMX.",required:!1,label:"Address"},emissionDate:{value:"2017-01-01",required:!1,label:"Emission Date",format:"date"},documentNumber:{value:"163631998",required:!0,label:"Document Number"},dateOfBirth:{value:"1992-07-18",required:!0,label:"Day of Birth",format:"date"},expirationDate:{value:"2027-12-31",required:!1,label:"Date of Expiration",format:"date"},documentType:{value:"ID",required:!1,label:"Document Type"},firstName:{value:"EDGAR DANIEL",required:!1,label:"First Name"},issueCountry:{value:"MEX",required:!1,label:"Issue Country"},nationality:{value:"MEX",required:!1,label:"Nationality"},sex:{value:"M",required:!1,label:"Sex"},surname:{value:"SALINAS LEDESMA",required:!1,label:"Surname"},cde:{value:"SLLDED92071809H000",required:!1,label:"Elector Key"},curp:{value:"SALE920718HDFLDD08",required:!1,label:"CURP"},ne:{value:"01",required:!1,label:"Emission Number"},ocrNumber:{value:"5182086432677",required:!1,label:"OCR Number"}},error:null}],fields:{address:{value:"AV MARINA NACIONAL 200 EDIF 1 A 74 U HAB MARINA NACIONAL 11320 MIGUEL HIDALGO, CDMX."},cde:{value:"SLLDED92071809H000"},curp:{value:"SALE920718HDFLDD08"},dateOfBirth:{value:"1992-07-18"},documentNumber:{value:"163631998"},documentType:{value:"ID"},emissionDate:{value:"2017-01-01"},expirationDate:{value:"2027-12-31"},firstName:{value:"EDGAR DANIEL"},fullName:{value:"EDGAR DANIEL SALINAS LEDESMA"},issueCountry:{value:"MEX"},nationality:{value:"MEX"},ne:{value:"01"},ocrNumber:{value:"5182086432677"},sex:{value:"M"},surname:{value:"SALINAS LEDESMA"}},photos:["https://media.getmati.com/file?location=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWxlTmFtZSI6ImQwNmM2YWI0LTM2YmYtNDdkOC04NzE3LWQ0Y2NlNDRmNDU5ZC5qcGVnIiwiZm9sZGVyIjoiZG9jdW1lbnQiLCJpYXQiOjE2ODgzNDAyMTMsImV4cCI6MTY4ODQyNjYxMywiYXVkIjoiZWFjMTYwZmYtYTBlNS00M2QxLWFkNTktNTIwMjI1YmQ3OWI4In0.2mkLDqtZfGz8XcraYd1PoZnoYkkwUrPxXCvmYehQHxY","https://media.getmati.com/file?location=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWxlTmFtZSI6ImNlYzdlNjE4LTVkMmMtNDcxNi05MWM4LWUxYTAyM2RiMWNiNC5qcGVnIiwiZm9sZGVyIjoiZG9jdW1lbnQiLCJpYXQiOjE2ODgzNDAyMTMsImV4cCI6MTY4ODQyNjYxMywiYXVkIjoiZWFjMTYwZmYtYTBlNS00M2QxLWFkNTktNTIwMjI1YmQ3OWI4In0.aXVYcsK0D6VqfIeiTsRqZd2R_53G-sk7SD-SxB5Oq3g"]}],expired:!1,flow:{id:"64811ce44d683b001b9013ef",name:"Default flow"},identity:{id:"64a0f46f43bd9d001b7a2778",status:"verified"},steps:[{status:200,id:"liveness",cacheHit:null,data:{videoUrl:"https://media.getmati.com/file?location=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWxlTmFtZSI6Ijk2YTA0NTBlLWQzZGUtNGNjYS05MGFkLTQ5NGZiMjc4MGUwNy5ta3YiLCJmb2xkZXIiOiJ2aWRlbyIsImlhdCI6MTY4ODM0MDIxMywiZXhwIjoxNjg4NDI2NjEzLCJhdWQiOiJlYWMxNjBmZi1hMGU1LTQzZDEtYWQ1OS01MjAyMjViZDc5YjgifQ.TEQNks36DielBu29ThmFnColNqFYYwMWeehoaY-mTVk",spriteUrl:"https://media.getmati.com/file?location=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWxlTmFtZSI6IjEzOWMxNjhkLWY1MTUtNGEwNS04NWFjLTQ4ZjRjYmQ1MDI5Mi5qcGVnIiwiZm9sZGVyIjoic2VsZmllIiwiaWF0IjoxNjg4MzQwMjEzLCJleHAiOjE2ODg0MjY2MTMsImF1ZCI6ImVhYzE2MGZmLWEwZTUtNDNkMS1hZDU5LTUyMDIyNWJkNzliOCJ9.1qEptKVwj9lUI3P9trJXWy7HRpIA_nBpbXrlNwNPnoY",selfieUrl:"https://media.getmati.com/file?location=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWxlTmFtZSI6IjM5YWYwYzAzLTVlZWYtNDM5ZC1iZDNkLWI0N2RkZDlhYjg0MC5qcGVnIiwiZm9sZGVyIjoic2VsZmllIiwiaWF0IjoxNjg4MzQwMjEzLCJleHAiOjE2ODg0MjY2MTMsImF1ZCI6ImVhYzE2MGZmLWEwZTUtNDNkMS1hZDU5LTUyMDIyNWJkNzliOCJ9.wjiXYcGF13To2E4IqZL5u0MKLhkBwNdGhxy9VEzylD8"},error:null}],masJobToBePostpone:!1,profileId:"MX|NATIONAL-ID|163631998",id:"64a0f46f43bd9d001b7a277a",deviceFingerprint:{ua:"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36",browser:{name:"Chrome",version:"114.0.0.0",major:"114"},engine:{name:"Blink",version:"114.0.0.0"},os:{name:"Mac OS",version:"10.15.7"},app:{platform:"web_desktop",version:"22.3.5"},ip:"187.191.38.141",vpnDetectionEnabled:!1},hasProblem:!1})});t.json({docRef:n})}catch(e){J.error(e),t.status(b.INTERNAL_SERVER_ERROR).send(e)}}));const Re=t();Re.use(be),Re.use(De),Re.use(Ee),Re.use(fe),Re.use(Te),Re.use(e.static(`${_.distFolder}/user`,{dotfiles:"allow",setHeaders(e){e.set("Access-Control-Allow-Origin","*")}})),Re.get("*",((e,t)=>{t.sendFile(`${_.distFolder}/user/index.html`)}));(async()=>{await H,J.info("Blockchain connection initialized");const t=e();t.use(i.json()),t.use("/admin",X,ue),t.use("/",Re),J.info("Routes configured");const n="0.0.0.0",{port:a,baseUri:o}=_,s=t.listen(a,n,(()=>J.info(`Listening on ${o} (host: 0.0.0.0, port: ${a})`)));function r(){s.close(),process.exit(1)}process.on("unhandledRejection",r),process.on("uncaughtException",r)})();
//# sourceMappingURL=server.js.map
